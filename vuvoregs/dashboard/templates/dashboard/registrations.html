{% extends 'dashboard/base.html' %}
{% load dashboard_extras %}

{% block content %}
<h2 class="mb-4">Registrations</h2>

<!-- Filter Form -->
<form method="get" class="row g-3 mb-4">
    <!-- Event Selector -->
    <div class="col-md-4">
        <label for="event" class="form-label">Select Event:</label>
        <select name="event" id="event" class="form-select" onchange="this.form.submit()">
            <option value="">-- Select Event --</option>
            {% for event in events %}
                <option value="{{ event.id }}" {% if selected_event_id|default:'' == event.id|stringformat:"s" %}selected{% endif %}>
                    {{ event.name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- Per Page Selector -->
    <div class="col-md-2">
        <label for="per_page" class="form-label">Per Page:</label>
        <select name="per_page" id="per_page" class="form-select" onchange="this.form.submit()">
            {% for count in per_page_choices %}
                <option value="{{ count }}" {% if per_page == count %}selected{% endif %}>{{ count }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Search -->
    <div class="col-md-4">
        <label for="search" class="form-label">Search Athletes:</label>
        <input type="text" name="search" id="search" class="form-control" value="{{ search_query }}" placeholder="Search by name or email">
    </div>

    <!-- Submit -->
    <div class="col-md-2 align-self-end">
        <button type="submit" class="btn btn-primary w-100">
            <i class="fa fa-search me-1"></i>Search
        </button>
    </div>
</form>

{% if selected_event %}
    <h4>Event: {{ selected_event.name }}</h4>
    <p>Total Registrations: {{ registrations.count }}</p>
    <p>Total Athletes: {{ athletes.paginator.count }}</p>

    <!-- Athletes Table -->
    <table class="table table-bordered table-hover mt-4">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Athlete</th>
                <th>Email</th>
                <th>Race</th>
                <th>Package</th>
                {% for key in option_keys %}
                    <th>{{ key }}</th>
                {% endfor %}
                <th>Payment</th>
            </tr>
        </thead>
        <tbody>
            {% for athlete in athletes %}
            <tr>
                <td>{{ athlete.id }}</td>
                <td>{{ athlete.first_name }} {{ athlete.last_name }}</td>
                <td>{{ athlete.email }}</td>
                <td>{{ athlete.race.name }} ({{ athlete.race.race_km }} KM)</td>
                <td>{{ athlete.package.name }}</td>
                {% for key in option_keys %}
                    <td>{{ athlete.selected_options|get_item:key|default:"â€”" }}</td>
                {% endfor %}
                <td>
                    {% if athlete.registration.payment_status == 'paid' %}
                        <span class="badge bg-success">Paid</span>
                    {% elif athlete.registration.payment_status == 'failed' %}
                        <span class="badge bg-danger">Failed</span>
                    {% else %}
                        <span class="badge bg-secondary">Not Paid</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination -->
    <nav>
        <ul class="pagination justify-content-center">
            {% if athletes.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?event={{ selected_event_id }}&per_page={{ per_page }}&search={{ search_query }}&page={{ athletes.previous_page_number }}">Previous</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Previous</span></li>
            {% endif %}

            {% for num in athletes.paginator.page_range %}
                {% if num == athletes.number %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% else %}
                    <li class="page-item">
                        <a class="page-link" href="?event={{ selected_event_id }}&per_page={{ per_page }}&search={{ search_query }}&page={{ num }}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}

            {% if athletes.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?event={{ selected_event_id }}&per_page={{ per_page }}&search={{ search_query }}&page={{ athletes.next_page_number }}">Next</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Next</span></li>
            {% endif %}
        </ul>
    </nav>

{% else %}
    <div class="alert alert-info mt-4">Select an event to view athlete registrations.</div>
{% endif %}
{% endblock %}
